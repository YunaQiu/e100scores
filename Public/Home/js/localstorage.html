<script>
//坑爹Thinkphp！为什么不给我解析public里面的文件啊啊啊，人家要用:U函数啊喂~
var LocalStorage = (function(){
	localStorage = window.localStorage;

	function isExist(name){
		var userData = localStorage.getItem(name);
		if (userData){
			return true;
		}else{
			return false;
		}
	}
	function getStorage(name){
		var userData = localStorage.getItem(name);
		if (userData){
			return $.parseJSON(userData);	
		}else{
			return false;
		}
	}
	function setStorage(name, obj){
		var data = JSON.stringify(obj);
		localStorage.setItem(name, data);
	}

	return {
		isExist: isExist,
		get: getStorage,
		set: setStorage
	};
})();

function UserStorage(alias){
	var storage = window.localStorage;
	var name = alias + '-user';
	function isExist(){
		var userData = LocalStorage.isExist(name);
		return userData;
	}
	function getVer(){
		var userData = LocalStorage.get(name);
		var version = userData.version;
		if (typeof(version) == 'undefined'){
			return '1.0';
		}else{
			return version;
		}
	}
	/*数据结构版本更新（自己挖的坑，跪着也要填完）*/
	function updateVer(){
		var version = getVer();
		switch (getVer()){
			case '2.0':
				return;
			case '1.0':
				var userData = LocalStorage.get(name);
				var record = new Array();
				for (var i=0; i<userData.length; i++){
					record[i] = {checked: userData[i]};
				}
				var thisTime = new Date();
				var newData = {
					version: '2.0',
					record: record,
					updateTime: thisTime.Format(Config.TIME_FORMAT)
				};
				LocalStorage.set(name, newData);
				break;
		}
	}
	/**
	* 比较本地记录时间与cmpTime，判断哪个是最新的数据
	* @param cmpTime："yyyy-MM-dd hh:mm:ss"格式的字符串
	*/
	function theLatest(cmpTime){
		var userData = LocalStorage.get(name);
		if (!userData){
			var updateTime = '';
		}else{
			var updateTime = userData.updateTime;
		}
		var diff = timeDiff(updateTime, cmpTime);
		if (diff > 0){
			return 'remote';
		}else if (diff < 0){
			return 'local';
		}else{
			return 'equal';
		}
	}
	/*获取本地所有答题记录*/
	function getAllRecord(){
		var userData = LocalStorage.get(name);
		if (!userData){
			return false;
		}else{
			return userData.record;			
		}
	}
	/*根据答题对象数组更新本地用户数据*/
	function setAllRecord(obj){
		var userData = LocalStorage.get(name);
		if (!userData){
			userData = {version: '2.0'};
		}
		userData.record = obj;
		userData.updateTime = (new Date()).Format(Config.TIME_FORMAT);
		LocalStorage.set(name, userData);
	}
	/*根据题号返回该题的用户答题记录*/
	function getSingleRecord(number){
		var userData = LocalStorage.get(name);
		if (!userData){
			return false;
		}
		if (userData.record.length >= number){
			return userData.record[number-1].checked;
		}else{
			return false;
		}
	}
	/**
	* 根据题号、选项勾选数组记录用户答题数据 
	*/
	function setSingleRecord(number, obj){
		var userData = LocalStorage.get(name);
		if (!userData){
			userRecord = new Array();
		}else{
			userRecord = userData.record;
		}
		if (userRecord.length < number-1){
 			return false;
		}else if(userRecord.length == number-1){
			userRecord[number-1] = new Object();
 		}
		userRecord[number-1].checked = obj;
		setAllRecord(userRecord);
		return true;
	}
	function uploadCloud(fun){
		var userData = LocalStorage.get(name);
		var data = JSON.stringify(userData.record);
		console.log(data);
		$.post('{:U("Practice/updateUserData")}', 
			{
				bank: alias,
				data: data,
				time: userData.updateTime
			},function(data){
				console.log(data);
				if (typeof(fun) == "function"){
					fun(data);				
				}
			});
	}
	function downloadData(fun){
		$.post('{:U("Practice/loadUserData")}', {bank: alias}, function(result){
			console.log(result);
			if (result.status == 0){
				setAllRecord(result.data);
				setUpdateTime(result.time);
			}
			if (typeof(fun) == "function"){
				fun(result.status);				
			}
		}, 'json');
	}
	function clearData(fun){
		$.post('{:U("Practice/clearUserData")}', {bank: alias},function(data){
			storage.removeItem(name);
			console.log(data);
			if (typeof(fun) == "function"){
				fun();				
			}
		});
	}
	function setUpdateTime(time){
		var userData = LocalStorage.get(name);
		userData.updateTime = time;
		LocalStorage.set(name, userData);
	}

	this.isExist = isExist;
	this.getVer = getVer;
	this.updateVer = updateVer;
	this.theLatest = theLatest;
	this.getAll = getAllRecord;
	this.setAll = setAllRecord;
	this.get = getSingleRecord;
	this.set = setSingleRecord;
	this.upload = uploadCloud;
	this.download = downloadData;
	this.clear = clearData;
}

function BankStorage(name){
	this.name = name;
	function isExist(){
		var result = LocalStorage.isExist(name);
		return result;
	}
	function getStorage(){
		var bankData = LocalStorage.get(name);
		return bankData;
	}
	function download(fun){
		$.post('{:U("Practice/loadBank")}', {bank: this.name}, function(result){
			if (result.status == 0){
				LocalStorage.set(name, result.data);
			}
			console.log(result);
			if (typeof(fun) == "function"){
				fun(result.status);				
			}
		}, 'json');
	}
	function getSingleRecord(number){
		var bankData = LocalStorage.get(this.name);
		if (bankData.length >= number){
			return bankData[number-1];
		}else{
			return false;
		}
	}

	this.isExist = isExist;
	this.load = download;
	this.getAll = getStorage;
	this.get = getSingleRecord;
};
</script>